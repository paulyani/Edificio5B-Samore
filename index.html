<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Aviso Edificio</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PWA y Theming (Para la instalación) -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <link rel="apple-touch-icon" href="logo-edificio.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Aviso Edificio">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Lato', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background: #e0e0e0;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
        }
        .title-font { font-family: 'Playfair Display', serif; }
        .form-select, .form-input {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bell-shake { animation: bell-shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes bell-shake {
            0%, 100% { transform: rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(13deg); }
            20%, 40%, 60%, 80% { transform: rotate(-13deg); }
        }
        .btn-pulse:hover svg.whatsapp-icon { transform: scale(1.1); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-sm mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
        <div class="bg-blue-900 text-center p-6">
            <svg class="w-12 h-12 text-yellow-300 mx-auto bell-shake" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
            <h1 class="title-font text-3xl font-bold text-white mt-2">Portería</h1>
            <p class="text-blue-200 text-sm">Aviso a Residente</p>
        </div>

        <div class="p-6 space-y-4">
            <!-- Selector Departamento -->
            <div>
                <label for="depto" class="text-sm font-bold text-gray-600">Departamento</label>
                <div class="relative mt-1">
                    <select id="depto" class="form-select w-full pl-3 pr-10 py-2.5 text-base bg-gray-50 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition">
                        <option value="">-- Seleccionar --</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Selector Contacto -->
            <div id="persona-container" class="hidden">
                <label for="persona" class="text-sm font-bold text-gray-600">Contacto</label>
                <div class="relative mt-1">
                    <select id="persona" class="form-select w-full pl-3 pr-10 py-2.5 text-base bg-gray-50 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition"></select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                       <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                    </div>
                </div>
            </div>
            
            <!-- Selector de Tipo -->
            <div>
                <label for="tipo-select" class="text-sm font-bold text-gray-600">Motivo</label>
                 <div class="relative mt-1">
                    <select id="tipo-select" class="form-select w-full pl-3 pr-10 py-2.5 text-base bg-gray-50 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition">
                        <option value="">-- Seleccionar motivo --</option>
                        <option value="Delivery">Delivery</option>
                        <option value="Cartero">Cartero</option>
                        <option value="Amigo/a">Amigo/a</option>
                        <option value="Visitante">Visitante</option>
                        <option value="Otro">Otro...</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Input para "Otro" -->
            <div id="tipo-otro-container" class="hidden">
                <input type="text" id="tipo-otro-input" placeholder="Especificar otro motivo" class="form-input w-full px-3 py-2.5 text-base bg-gray-50 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition">
            </div>

            <!-- Botones de Acción -->
            <div class="pt-4 space-y-3">
                <button id="btnEnviar" class="btn-pulse w-full flex items-center justify-center gap-3 text-blue-900 bg-yellow-400 hover:bg-yellow-500 focus:ring-4 focus:ring-yellow-300 font-bold rounded-lg text-base px-5 py-3 transition shadow-md hover:shadow-lg transform hover:scale-105">
                    <svg class="w-6 h-6 whatsapp-icon transition-transform" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path clip-rule="evenodd" fill-rule="evenodd" d="M18.403 5.633A8.919 8.919 0 0012.053 3c-4.948 0-8.976 4.027-8.976 8.974 0 1.582.413 3.126 1.198 4.488L3 21l4.629-1.217a8.955 8.955 0 004.425 1.189h.001c4.948 0 8.975-4.027 8.975-8.974 0-2.41-1.03-4.625-2.655-6.265zm-6.35 13.812h-.001a7.446 7.446 0 01-3.79-1.047l-.272-.162-2.824.741.753-2.753-.177-.282a7.44 7.44 0 01-1.14-3.971c0-4.102 3.337-7.44 7.44-7.44a7.425 7.425 0 015.263 2.178 7.425 7.425 0 012.178 5.263c-.002 4.102-3.338 7.44-7.442 7.44zm3.813-5.365c-.21-.104-1.233-.605-1.425-.675s-.332-.104-.473.105c-.14.21-.537.675-.657.815-.12.14-.24.158-.45.052-.207-.104-.873-.32-1.662-.99-.613-.52-1.027-1.162-1.148-1.362s-.122-.303-.012-.407c.09-.09.21-.24.314-.364.104-.124.14-.21.21-.35.07-.14.035-.262-.018-.367s-.472-1.14-.647-1.562c-.175-.412-.354-.355-.473-.36-.114-.007-.248-.007-.38-.007s-.366.052-.557.262c-.19.21-.73.71-..9 1.772s.21 2.113.24 2.253c.034.14 1.425 2.183 3.456 3.037.49.207.873.332 1.17.427.472.157.9.117 1.232.07.396-.052 1.233-.505 1.408-.99.175-.487.175-.903.122-.99s-.14-.14-.298-.24z"></path></svg>
                    <span>Enviar al Dpto</span>
                </button>
                <button id="btnPorteria" class="w-full text-gray-700 bg-gray-200 hover:bg-gray-300 focus:ring-4 focus:ring-gray-300 font-semibold rounded-lg text-base px-5 py-3 transition">Avisar a Portería General</button>
            </div>
             <div id="mensaje" class="mt-4 font-medium h-6 text-center text-sm"></div>
        </div>
    </div>

    <script src="contactos.js"></script>
    <script>
        // --- Registro del Service Worker para PWA ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').then(registration => {
                    console.log('Service Worker registrado con éxito:', registration.scope);
                }).catch(err => {
                    console.log('Fallo en el registro del Service Worker:', err);
                });
            });
        }
        
        let audioContext;
        // Función para reproducir el sonido de la campana
        function playBellSound() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(988, audioContext.currentTime); // Tono agudo (B5)
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.error("No se pudo reproducir el sonido:", e);
            }
        }
        
        // --- Lógica de la aplicación ---
        const contactos = buildingContactsData;
        const deptoSelect = document.getElementById("depto");
        const personaContainer = document.getElementById("persona-container");
        const personaSelect = document.getElementById("persona");
        const tipoSelect = document.getElementById('tipo-select');
        const tipoOtroContainer = document.getElementById('tipo-otro-container');
        const tipoOtroInput = document.getElementById('tipo-otro-input');
        const mensajeDiv = document.getElementById("mensaje");

        function populateDeptoSelect() {
            const sortedDepts = Object.keys(contactos).sort((a, b) => a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'}));
            sortedDepts.forEach(depto => {
                const option = document.createElement('option');
                option.value = depto;
                option.textContent = depto;
                deptoSelect.appendChild(option);
            });
        }
        
        window.addEventListener("load", () => {
            if (typeof buildingContactsData === 'undefined') {
                mostrarMensaje("Error: No se pudo cargar la lista de contactos.", "red");
                return;
            }
            populateDeptoSelect();
            const ultimoDepto = localStorage.getItem("ultimoDepto");
            if (ultimoDepto && contactos[ultimoDepto]) {
                deptoSelect.value = ultimoDepto;
                actualizarPersonas();
            }
            // Reproducir sonido en la primera interacción para cumplir políticas de autoplay
            document.body.addEventListener('click', playBellSound, { once: true });
        });

        deptoSelect.addEventListener("change", actualizarPersonas);

        tipoSelect.addEventListener('change', () => {
            if (tipoSelect.value === 'Otro') {
                tipoOtroContainer.classList.remove('hidden');
                tipoOtroContainer.classList.add('fade-in');
                tipoOtroInput.focus();
            } else {
                tipoOtroContainer.classList.add('hidden');
            }
        });

        function actualizarPersonas() {
            const depto = deptoSelect.value;
            localStorage.setItem("ultimoDepto", depto);
            const personas = contactos[depto] || [];
            personaSelect.innerHTML = "";

            if (personas.length > 0) {
                personaContainer.classList.remove('hidden');
                personaContainer.classList.add('fade-in');
                personas.forEach(p => {
                    const opt = document.createElement("option");
                    opt.value = p.numero;
                    opt.textContent = p.nombre;
                    personaSelect.appendChild(opt);
                });
            } else {
                personaContainer.classList.add('hidden');
            }
        }
        
        function mostrarMensaje(msg, isError = false) {
            mensajeDiv.textContent = msg;
            mensajeDiv.style.color = isError ? '#ef4444' : '#10b981';
            setTimeout(() => (mensajeDiv.textContent = ""), 4000);
        }

        function enviarMensaje() {
            playBellSound(); // Reproducir sonido al hacer clic
            const depto = deptoSelect.value;
            if (!depto) {
                mostrarMensaje("Seleccioná un departamento.", true);
                return;
            }
            
            const numeroPersona = personaSelect.value;
            if (!numeroPersona) {
                mostrarMensaje("Seleccioná un contacto.", true);
                return;
            }

            let tipo = tipoSelect.value;
            if (tipo === 'Otro') {
                tipo = tipoOtroInput.value.trim();
            }
            if (!tipo) {
                mostrarMensaje("Seleccioná o ingresá un motivo.", true);
                return;
            }

            const texto = `Hola, te busca ${tipo}. Estoy en la entrada del edificio para comunicarme con el Dpto ${depto}.`;
            const encodedMsg = encodeURIComponent(texto);
            const esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            const baseUrl = esMovil ? "https://api.whatsapp.com/send" : "https://web.whatsapp.com/send";
            
            const url = `${baseUrl}?phone=${numeroPersona}&text=${encodedMsg}`;
            window.open(url, "_blank");

            mostrarMensaje(`Mensaje preparado para enviar.`);
        }

        function avisarPorteria() {
            playBellSound(); // Reproducir sonido también en este botón
            const porteriaContact = contactos["PORTERIA"] && contactos["PORTERIA"][0];
            if (!porteriaContact) {
                mostrarMensaje("No hay contacto de portería definido.", true);
                return;
            }
            const texto = "Hola, estoy en la entrada del edificio. Necesito comunicarme con la portería.";
            const encodedMsg = encodeURIComponent(texto);
            const esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            const baseUrl = esMovil ? "https://api.whatsapp.com/send" : "https://web.whatsapp.com/send";
            const url = `${baseUrl}?phone=${porteriaContact.numero}&text=${encodedMsg}`;
            window.open(url, "_blank");
            mostrarMensaje("Aviso enviado a portería.");
        }

        document.getElementById("btnEnviar").addEventListener("click", enviarMensaje);
        document.getElementById("btnPorteria").addEventListener("click", avisarPorteria);
    </script>
</body>
</html>