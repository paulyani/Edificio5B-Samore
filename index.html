<!-- ... el <head> y los estilos son los mismos que antes ... -->

<main>
  <label for="depto">Seleccioná el departamento</label>
  <select id="depto" onchange="actualizarPersonas()">
    <option value="">-- Seleccioná un depto --</option>
  </select>

  <label for="tipo">¿Quién sos?</label>
  <select id="tipo">
    <option value="Cartero">Cartero</option>
    <option value="Delivery">Delivery</option>
    <option value="Amigo">Amigo</option>
    <option value="Familiar">Familiar</option>
  </select>

  <div id="persona-container">
    <label for="persona">¿A quién querés avisar?</label>
    <select id="persona"></select>
  </div>

  <button onclick="enviarMensaje()">Enviar Aviso</button>
  <button onclick="avisarPorteria()">Avisar a Portería</button>

  <div id="mensaje" class="confirmacion"></div>
</main>

<script>
  const pisos = ["PB", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
  const unidades = ["D", "E", "F"];
  const contactos = {
    "PB-Porteria": ["5491111111111"],
    "PB-E": ["5491111111112"],
    "PB-F": ["5491111111113"],
    "1-D": ["5491111111114"],
    "1-E": ["5491111111115"],
    "1-F": ["5491111111116"],
    "9-E": ["5491139485857", "5491131617118", "5491166535883"],
    "9-F": ["5491123312815", "5491122775434"]
  };

  const deptoSelect = document.getElementById("depto");
  const personaContainer = document.getElementById("persona-container");
  const personaSelect = document.getElementById("persona");

  // Cargar deptos al dropdown
  pisos.forEach(piso => {
    unidades.forEach(unidad => {
      const val = `${piso}-${unidad}`;
      if (contactos[val]) {
        const option = document.createElement("option");
        option.value = val;
        option.textContent = `Dpto ${val}`;
        deptoSelect.appendChild(option);
      }
    });
  });

  // Recordar el último departamento seleccionado
  if (localStorage.getItem("ultimoDepto")) {
    deptoSelect.value = localStorage.getItem("ultimoDepto");
    actualizarPersonas();
  }

  function actualizarPersonas() {
    const depto = deptoSelect.value;
    localStorage.setItem("ultimoDepto", depto);

    const numeros = contactos[depto] || [];
    personaSelect.innerHTML = "";

    if (numeros.length > 1) {
      personaContainer.style.display = "block";
      numeros.forEach((nro, index) => {
        const ultimos = nro.slice(-4);
        const opt = document.createElement("option");
        opt.value = nro;
        opt.textContent = `Persona ${index + 1} (••••${ultimos})`;
        personaSelect.appendChild(opt);
      });
    } else {
      personaContainer.style.display = "none";
    }
  }

  function mostrarMensajeHTML(html) {
    const msg = document.getElementById("mensaje");
    msg.innerHTML = html;
  }

  function enviarMensaje() {
    const depto = deptoSelect.value;
    const tipo = document.getElementById("tipo").value;

    if (!depto) {
      mostrarMensajeHTML("<span style='color:red'>Seleccioná un departamento.</span>");
      return;
    }

    const numeros = contactos[depto];
    if (!numeros || numeros.length === 0) {
      mostrarMensajeHTML("<span style='color:red'>Este departamento no tiene números asignados.</span>");
      return;
    }

    const msg = `Hola, soy ${tipo}. Estoy en la entrada del edificio y quiero comunicarme con el Dpto ${depto}.`;
    const encodedMsg = encodeURIComponent(msg);
    const esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const baseUrl = esMovil ? "https://api.whatsapp.com/send" : "https://web.whatsapp.com/send";

    let numeroFinal = numeros[0]; // por defecto
    if (numeros.length > 1) {
      numeroFinal = personaSelect.value;
    }

    const url = `${baseUrl}?phone=${numeroFinal.trim()}&text=${encodedMsg}`;
    window.open(url, "_blank");
    mostrarMensajeHTML("Enlace abierto para enviar aviso.");
  }

  function avisarPorteria() {
    const msg = "Hola, estoy en la entrada del edificio. Necesito comunicarme con la portería.";
    const encodedMsg = encodeURIComponent(msg);
    const numeros = contactos["PB-Porteria"];
    const esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const baseUrl = esMovil ? "https://api.whatsapp.com/send" : "https://web.whatsapp.com/send";

    const url = `${baseUrl}?phone=${numeros[0]}&text=${encodedMsg}`;
    window.open(url, "_blank");
    mostrarMensajeHTML("Aviso enviado a portería.");
  }
</script>
